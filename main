import discord
from discord.ext import commands
import json
import os

# =========================
# ‚öô –ù–ê–°–¢–†–û–ô–ö–ò
# =========================

TOKEN = 
XP_FILE = "xp_data.json"

ALLOWED_ROLES = {
    1443204937562718209,
    1443826467149451375,
    1443205373799698463,
    1442937053099856044
}

LOG_CHANNEL_ID = 1439359916174213261

# =========================
# üìÅ –§–ê–ô–õ XP
# =========================

if not os.path.exists(XP_FILE):
    with open(XP_FILE, "w", encoding="utf-8") as f:
        json.dump({}, f, ensure_ascii=False, indent=4)

with open(XP_FILE, "r", encoding="utf-8") as f:
    xp_data = json.load(f)

# =========================
# ü§ñ –ë–û–¢
# =========================

intents = discord.Intents.all()
bot = commands.Bot(command_prefix="!", intents=intents)


def save():
    with open(XP_FILE, "w", encoding="utf-8") as f:
        json.dump(xp_data, f, ensure_ascii=False, indent=4)


def allowed(ctx):
    return any(role.id in ALLOWED_ROLES for role in ctx.author.roles)


# =====================================================
# üéÅ –í–´–î–ê–ß–ê XP –û–î–ù–û–ú–£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ ‚Äî !—Ö–ø–≥–∏–≤
# =====================================================
@bot.command(name="—Ö–ø–≥–∏–≤")
async def give_xp(ctx, amount: int, reason: str, member: discord.Member):
    if not allowed(ctx):
        return await ctx.send("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!")

    uid = str(member.id)

    if uid not in xp_data:
        xp_data[uid] = {"xp": 0, "cake": 0}

    xp_data[uid]["xp"] += amount
    save()

    emb = discord.Embed(
        title="üéÑ –í—ã–¥–∞—á–∞ XP!",
        description=f"{member.mention} –ø–æ–ª—É—á–∏–ª **{amount} XP**",
        color=discord.Color.green()
    )
    emb.add_field(name="–ü—Ä–∏—á–∏–Ω–∞:", value=reason)
    emb.set_footer(text="–° –ù–æ–≤—ã–º –≥–æ–¥–æ–º! ‚ùÑ‚ú®")

    await ctx.send(embed=emb)

    log = bot.get_channel(LOG_CHANNEL_ID)
    if log:
        await log.send(embed=emb)


# =====================================================
# üç∞ –í–´–î–ê–ß–ê –¢–û–†–¢–ò–ö–û–í –û–î–ù–û–ú–£ ‚Äî !—Ç–æ—Ä—Ç–≥–∏–≤
# =====================================================
@bot.command(name="—Ç–æ—Ä—Ç–≥–∏–≤")
async def give_cake(ctx, amount: int, reason: str, member: discord.Member):
    if not allowed(ctx):
        return await ctx.send("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!")

    uid = str(member.id)

    if uid not in xp_data:
        xp_data[uid] = {"xp": 0, "cake": 0}

    xp_data[uid]["cake"] += amount
    save()

    emb = discord.Embed(
        title="üéÇ –í—ã–¥–∞—á–∞ —Ç–æ—Ä—Ç–∏–∫–æ–≤!",
        description=f"{member.mention} –ø–æ–ª—É—á–∏–ª **{amount} üç∞**",
        color=discord.Color.purple()
    )
    emb.add_field(name="–ü—Ä–∏—á–∏–Ω–∞:", value=reason)
    emb.set_footer(text="–°–ª–∞–¥–∫–æ–≥–æ –ù–æ–≤–æ–≥–æ –≥–æ–¥–∞! üéÑ‚ú®")

    await ctx.send(embed=emb)

    log = bot.get_channel(LOG_CHANNEL_ID)
    if log:
        await log.send(embed=emb)


# =====================================================
# üéß –í–´–î–ê–ß–ê XP –í–°–ï–ú –í –í–û–ô–°–ï ‚Äî !—Ö–ø–≤–æ–π—Å
# =====================================================
@bot.command(name="—Ö–ø–≤–æ–π—Å")
async def give_xp_voice(ctx, amount: int, reason: str):
    if not allowed(ctx):
        return await ctx.send("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!")

    if ctx.author.voice is None:
        return await ctx.send("‚ùå –¢—ã –Ω–µ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ!")

    vc = ctx.author.voice.channel
    members = vc.members
    count = 0

    for m in members:
        if m.bot:
            continue

        uid = str(m.id)

        if uid not in xp_data:
            xp_data[uid] = {"xp": 0, "cake": 0}

        xp_data[uid]["xp"] += amount
        count += 1

    save()

    emb = discord.Embed(
        title="üéß XP –≤—Å–µ–º—É –≤–æ–π—Å—É!",
        description=f"–ö–∞–Ω–∞–ª: **{vc.name}**\n–í—ã–¥–∞–Ω–æ: **{amount} XP** –∫–∞–∂–¥–æ–º—É",
        color=discord.Color.green()
    )
    emb.add_field(name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:", value=count)
    emb.add_field(name="–ü—Ä–∏—á–∏–Ω–∞:", value=reason)
    emb.set_footer(text="–° –ù–æ–≤—ã–º –≥–æ–¥–æ–º! ‚ùÑ‚ú®")

    await ctx.send(embed=emb)

    log = bot.get_channel(LOG_CHANNEL_ID)
    if log:
        await log.send(embed=emb)


# =====================================================
# üéß –í–´–î–ê–ß–ê –¢–û–†–¢–ò–ö–û–í –í–°–ï–ú –í –í–û–ô–°–ï ‚Äî !—Ç–æ—Ä—Ç–≤–æ–π—Å
# =====================================================
@bot.command(name="—Ç–æ—Ä—Ç–≤–æ–π—Å")
async def give_cake_voice(ctx, amount: int, reason: str):
    if not allowed(ctx):
        return await ctx.send("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!")

    if ctx.author.voice is None:
        return await ctx.send("‚ùå –¢—ã –Ω–µ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ!")

    vc = ctx.author.voice.channel
    members = vc.members
    count = 0

    for m in members:
        if m.bot:
            continue

        uid = str(m.id)

        if uid not in xp_data:
            xp_data[uid] = {"xp": 0, "cake": 0}

        xp_data[uid]["cake"] += amount
        count += 1

    save()

    emb = discord.Embed(
        title="üéÇ –¢–æ—Ä—Ç–∏–∫–∏ –≤—Å–µ–º—É –≤–æ–π—Å—É!",
        description=f"–ö–∞–Ω–∞–ª: **{vc.name}**\n–í—ã–¥–∞–Ω–æ: **{amount} üç∞** –∫–∞–∂–¥–æ–º—É",
        color=discord.Color.purple()
    )
    emb.add_field(name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:", value=count)
    emb.add_field(name="–ü—Ä–∏—á–∏–Ω–∞:", value=reason)
    emb.set_footer(text="–°–ª–∞–¥–∫–æ–≥–æ –ù–æ–≤–æ–≥–æ –≥–æ–¥–∞! üéÑ‚ú®")

    await ctx.send(embed=emb)

    log = bot.get_channel(LOG_CHANNEL_ID)
    if log:
        await log.send(embed=emb)


# =====================================================
# üìä –ü–†–û–í–ï–†–ö–ê XP ‚Äî !—Ö–ø—á–µ–∫
# =====================================================
@bot.command(name="—Ö–ø—á–µ–∫")
async def xp_check(ctx, member: discord.Member):
    uid = str(member.id)

    if uid not in xp_data:
        xp_data[uid] = {"xp": 0, "cake": 0}
        save()

    xp = xp_data[uid]["xp"]

    emb = discord.Embed(
        title="üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ XP",
        description=f"–£ **{member.display_name}**: **{xp} XP**",
        color=discord.Color.blue()
    )
    await ctx.send(embed=emb)


# =====================================================
# üç∞ –ü–†–û–í–ï–†–ö–ê –¢–û–†–¢–ò–ö–û–í ‚Äî !—Ç–æ—Ä—Ç—á–µ–∫
# =====================================================
@bot.command(name="—Ç–æ—Ä—Ç—á–µ–∫")
async def cake_check(ctx, member: discord.Member):
    uid = str(member.id)

    if uid not in xp_data:
        xp_data[uid] = {"xp": 0, "cake": 0}
        save()

    cake = xp_data[uid]["cake"]

    emb = discord.Embed(
        title="üç∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä—Ç–∏–∫–æ–≤",
        description=f"–£ **{member.display_name}**: **{cake} üç∞**",
        color=discord.Color.orange()
    )
    await ctx.send(embed=emb)



# =========================
# ‚ñ∂ –°–¢–ê–†–¢ –ë–û–¢–ê
# =========================

bot.run(TOKEN)
